

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Re-Chunking Larger Datasets &#8212; HyTEST Project</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" />

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'dataset_preprocessing/tutorials/rechunking/ReChunkingData_Cloud';</script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Evaluation Metrics" href="../../../evaluation/metrics.html" />
    <link rel="prev" title="Re-Chunking Data" href="ReChunkingData.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>


  <div class="bd-header-announcement container-fluid bd-header-announcement">
    <div class="bd-header-announcement__content">v0.0.1_alpha01</div>
  </div>

  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../../doc/About.html">
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/HyTEST_Badge.svg" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../../_static/HyTEST_Badge.svg" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Environment Set-Up</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../environment_set_up/README.html">Compute Environments</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../environment_set_up/QuickStart-General.html">General QuickStart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../environment_set_up/QuickStart-Cloud-pangeoCHS.html">Cloud: pangeo.chs.usgs.gov Quick-Start</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../environment_set_up/QuickStart-Cloud-Nebari.html">Cloud: Nebari Quick-Start</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../environment_set_up/OpenOnDemand.html">HPC Server: Open OnDemand Quick-Start</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../environment_set_up/JupyterForward.html">HPC Server: Jupyter Forward Quick-Start</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../environment_set_up/StartScript.html">HPC Server: Start Script Quick-Start</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../environment_set_up/Help_AWS_Credentials.html">AWS Credentials</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../environment_set_up/clusters.html">Starting a Dask Cluster</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../environment_set_up/Start_Dask_Cluster_Nebari.html">nebari.esipfed.org Dask Cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../environment_set_up/Start_Dask_Cluster_PangeoCHS.html">pangeo.chs.usgs.gov Dask Cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../environment_set_up/Start_Dask_Cluster_Denali.html">Denali HPC Dask Cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../environment_set_up/Start_Dask_Cluster_Tallgrass.html">Tallgrass HPC Dask Cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../environment_set_up/Start_Dask_Cluster_Desktop.html">Local Desktop Dask Cluster</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../essential_reading/README.html">Essential Reading</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../essential_reading/ReadingsTutorials.html">Foundations</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../essential_reading/DataSources/README.html">Data Sources</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../essential_reading/DataSources/Data_APIs.html">Data/APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../essential_reading/DataSources/Data_S3.html">Data/Cloud Storage</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../essential_reading/Parallel_Dask.html">Parallelism with Dask</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Dataset Access</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../dataset_catalog/README.html">HyTEST Data Catalog (Intake)</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../dataset_catalog/subcatalogs/README.html">HyTEST Intake Sub-Catalogs</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../dataset_access/README.html">CONUS404 Access</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../dataset_access/conus404_explore.html">Explore CONUS404 Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dataset_access/conus404_temporal_aggregation.html">CONUS404 Temporal Aggregation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dataset_access/conus404_spatial_aggregation.html">CONUS404 Spatial Aggregation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dataset_access/conus404_regrid.html">CONUS404 Regridding (Curvilinear =&gt; Rectilinear)</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Dataset Preprocessing</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../../chunk.html">Chunking Data</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ReChunkingData.html">Re-Chunking Data</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Re-Chunking Larger Datasets</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Model Evaluation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../evaluation/metrics.html">Evaluation Metrics</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../evaluation/Metrics_DScore_Suite_v1.html">D-Score Suite (v1) Benchmark</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../evaluation/tutorials/stats/Usage_DScore_Suite_v1.html">D-Score Suite (v1) Benchmark – Usage Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../evaluation/Metrics_StdSuite_v1.html">Standard Suite (v1) Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../evaluation/tutorials/stats/Usage_StdSuite_v1.html">Standard Suite (v1) Metrics – Usage Examples</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../evaluation/tutorials/nwm_streamflow/00_Overview.html">Streamflow Model Evaluation</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../evaluation/tutorials/nwm_streamflow/01_Data_Prep.html">Streamflow Eval :: Data Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../evaluation/tutorials/nwm_streamflow/02_Analysis_StdSuite.html">Streamflow Eval :: StdSuite Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../evaluation/tutorials/nwm_streamflow/02_Analysis_DScore.html">Steamflow Eval :: DScore Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../evaluation/tutorials/nwm_streamflow/03_Vizualization.html">Streamflow Eval :: Visualization</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Back Matter</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../doc/CONTRIBUTING.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc/LICENSE.html">License</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/hytest-org/hytest" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/dataset_preprocessing/tutorials/rechunking/ReChunkingData_Cloud.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Re-Chunking Larger Datasets</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#system-setup">System Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plumb-data-source">Plumb Data Source</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-zarr-data">Load the zarr data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#restrict-for-tutorial">Restrict for Tutorial</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spin-up-dask-cluster">Spin up Dask Cluster</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#re-chunk-plan">Re-Chunk Plan</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-output-location">Set up output location</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ready-to-rechunk">Ready to rechunk</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison">Comparison</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="re-chunking-larger-datasets">
<h1>Re-Chunking Larger Datasets<a class="headerlink" href="#re-chunking-larger-datasets" title="Permalink to this headline">#</a></h1>
<p>This notebook extends ideas covered in the <a class="reference internal" href="ReChunkingData.html"><span class="doc std std-doc">basic workflow</span></a>.  This
notebook will perfrom the same operations, but will work on the <strong>much</strong> larger dataset, and
involve some parallelization using the dask scheduler.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You should run this <strong>only</strong> on a cloud compute node – on ESIP Nebari, for example. We
will be reading and writing <strong>enormous</strong> amounts of data to S3 buckets. To do that over a
typical network connection will saturate your bandwidth and take days to complete.</p>
</div>
<section id="system-setup">
<h2>System Setup<a class="headerlink" href="#system-setup" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">dask</span>
<span class="kn">import</span> <span class="nn">intake</span>

<span class="c1"># Activate logging</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plumb-data-source">
<h2>Plumb Data Source<a class="headerlink" href="#plumb-data-source" title="Permalink to this headline">#</a></h2>
<p>We’re going to look at a particular dataset from the National Water Model Reanalysis Version 2.1.
The dataset is part of the AWS Open Data Program, and is included in the HyTEST data catalog.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/hytest-org/hytest/main/dataset_catalog/hytest_intake_catalog.yml&#39;</span>
<span class="n">cat</span> <span class="o">=</span> <span class="n">intake</span><span class="o">.</span><span class="n">open_catalog</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">cat</span><span class="p">[</span><span class="s1">&#39;nwm21-streamflow-cloud&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>nwm21-streamflow-cloud:
  args:
    consolidated: true
    storage_options:
      anon: true
    urlpath: s3://noaa-nwm-retrospective-2-1-zarr-pds/chrtout.zarr
  description: National Water Model 2.1 CHRTOUT on AWS
  driver: intake_xarray.xzarr.ZarrSource
  metadata:
    catalog_dir: https://raw.githubusercontent.com/hytest-org/hytest/main/dataset_catalog
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-the-zarr-data">
<h2>Load the zarr data<a class="headerlink" href="#load-the-zarr-data" title="Permalink to this headline">#</a></h2>
<p>We’ll take advantage of the <code class="docutils literal notranslate"><span class="pre">intake</span></code> mechanism and load the data
directly.  We’ll need to set up our AWS credentials first, since
this data is stored on an S3 bucket.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AWS_PROFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;osn-renci&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AWS_S3_ENDPOINT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;https://renc.osn.xsede.org&quot;</span>
<span class="o">%</span><span class="k">run</span> ../../../environment_set_up/Help_AWS_Credentials.ipynb
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ERROR:root:Problem parsing the AWS credentials file. 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;nwm21-streamflow-cloud&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dask</span><span class="p">()</span>
<span class="n">indexer</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">gage_id</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<span class="n">smplData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">indexer</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># subset to only those features with a valid gage_id</span>
<span class="n">smplData</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;crs&#39;</span><span class="p">)</span> <span class="c1"># Not needed/wanted for this analysis</span>
<span class="n">smplData</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ProfileNotFound</span><span class="g g-Whitespace">                           </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">ds</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s1">&#39;nwm21-streamflow-cloud&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dask</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">indexer</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">gage_id</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">smplData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">indexer</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># subset to only those features with a valid gage_id</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/intake_xarray/base.py:69,</span> in <span class="ni">DataSourceMixin.to_dask</span><span class="nt">(self)</span>
<span class="g g-Whitespace">     </span><span class="mi">67</span> <span class="k">def</span> <span class="nf">to_dask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">68</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Return xarray object where variables are dask arrays&quot;&quot;&quot;</span>
<span class="ne">---&gt; </span><span class="mi">69</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_chunked</span><span class="p">()</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/intake_xarray/base.py:44,</span> in <span class="ni">DataSourceMixin.read_chunked</span><span class="nt">(self)</span>
<span class="g g-Whitespace">     </span><span class="mi">42</span> <span class="k">def</span> <span class="nf">read_chunked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">43</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Return xarray object (which will have chunks)&quot;&quot;&quot;</span>
<span class="ne">---&gt; </span><span class="mi">44</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_load_metadata</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">45</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/intake/source/base.py:279,</span> in <span class="ni">DataSourceBase._load_metadata</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">277</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;load metadata only if needed&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">278</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">279</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_schema</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">280</span>     <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="o">.</span><span class="n">dtype</span>
<span class="g g-Whitespace">    </span><span class="mi">281</span>     <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="o">.</span><span class="n">shape</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/intake_xarray/base.py:18,</span> in <span class="ni">DataSourceMixin._get_schema</span><span class="nt">(self)</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">urlpath</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">18</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_open_dataset</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span>     <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
<span class="g g-Whitespace">     </span><span class="mi">21</span>         <span class="s1">&#39;dims&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">dims</span><span class="p">),</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span>         <span class="s1">&#39;data_vars&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span>                       <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()},</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span>         <span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ds</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<span class="g g-Whitespace">     </span><span class="mi">25</span>     <span class="p">}</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span>     <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;on_server&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/intake_xarray/xzarr.py:46,</span> in <span class="ni">ZarrSource._open_dataset</span><span class="nt">(self)</span>
<span class="g g-Whitespace">     </span><span class="mi">44</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">45</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">46</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">urlpath</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/xarray/backends/api.py:526,</span> in <span class="ni">open_dataset</span><span class="nt">(filename_or_obj, engine, chunks, cache, decode_cf, mask_and_scale, decode_times, decode_timedelta, use_cftime, concat_characters, decode_coords, drop_variables, inline_array, backend_kwargs, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">514</span> <span class="n">decoders</span> <span class="o">=</span> <span class="n">_resolve_decoders_kwargs</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">515</span>     <span class="n">decode_cf</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">516</span>     <span class="n">open_backend_dataset_parameters</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">open_dataset_parameters</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">522</span>     <span class="n">decode_coords</span><span class="o">=</span><span class="n">decode_coords</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">523</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">525</span> <span class="n">overwrite_encoded_chunks</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;overwrite_encoded_chunks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">526</span> <span class="n">backend_ds</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">527</span>     <span class="n">filename_or_obj</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="n">drop_variables</span><span class="o">=</span><span class="n">drop_variables</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="o">**</span><span class="n">decoders</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">530</span>     <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span> <span class="n">ds</span> <span class="o">=</span> <span class="n">_dataset_from_backend_dataset</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">533</span>     <span class="n">backend_ds</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">534</span>     <span class="n">filename_or_obj</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">542</span>     <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">543</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">544</span> <span class="k">return</span> <span class="n">ds</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/xarray/backends/zarr.py:891,</span> in <span class="ni">ZarrBackendEntrypoint.open_dataset</span><span class="nt">(self, filename_or_obj, mask_and_scale, decode_times, concat_characters, decode_coords, drop_variables, use_cftime, decode_timedelta, group, mode, synchronizer, consolidated, chunk_store, storage_options, stacklevel, zarr_version)</span>
<span class="g g-Whitespace">    </span><span class="mi">871</span> <span class="k">def</span> <span class="nf">open_dataset</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">872</span>     <span class="bp">self</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">873</span>     <span class="n">filename_or_obj</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">888</span>     <span class="n">zarr_version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">889</span> <span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">890</span>     <span class="n">filename_or_obj</span> <span class="o">=</span> <span class="n">_normalize_path</span><span class="p">(</span><span class="n">filename_or_obj</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">891</span>     <span class="n">store</span> <span class="o">=</span> <span class="n">ZarrStore</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">892</span>         <span class="n">filename_or_obj</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">893</span>         <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">894</span>         <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">895</span>         <span class="n">synchronizer</span><span class="o">=</span><span class="n">synchronizer</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">896</span>         <span class="n">consolidated</span><span class="o">=</span><span class="n">consolidated</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">897</span>         <span class="n">consolidate_on_close</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">898</span>         <span class="n">chunk_store</span><span class="o">=</span><span class="n">chunk_store</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">899</span>         <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">900</span>         <span class="n">stacklevel</span><span class="o">=</span><span class="n">stacklevel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">901</span>         <span class="n">zarr_version</span><span class="o">=</span><span class="n">zarr_version</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">902</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">904</span>     <span class="n">store_entrypoint</span> <span class="o">=</span> <span class="n">StoreBackendEntrypoint</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">905</span>     <span class="k">with</span> <span class="n">close_on_error</span><span class="p">(</span><span class="n">store</span><span class="p">):</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/xarray/backends/zarr.py:428,</span> in <span class="ni">ZarrStore.open_group</span><span class="nt">(cls, store, mode, synchronizer, group, consolidated, consolidate_on_close, chunk_store, storage_options, append_dim, write_region, safe_chunks, stacklevel, zarr_version)</span>
<span class="g g-Whitespace">    </span><span class="mi">425</span>             <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No such file or directory: &#39;</span><span class="si">{</span><span class="n">store</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">426</span> <span class="k">elif</span> <span class="n">consolidated</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">427</span>     <span class="c1"># TODO: an option to pass the metadata_key keyword</span>
<span class="ne">--&gt; </span><span class="mi">428</span>     <span class="n">zarr_group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_consolidated</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="o">**</span><span class="n">open_kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">429</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">430</span>     <span class="n">zarr_group</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="o">**</span><span class="n">open_kwargs</span><span class="p">)</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/zarr/convenience.py:1299,</span> in <span class="ni">open_consolidated</span><span class="nt">(store, metadata_key, mode, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1296</span>         <span class="n">metadata_key</span> <span class="o">=</span> <span class="s1">&#39;meta/root/consolidated/&#39;</span> <span class="o">+</span> <span class="n">metadata_key</span>
<span class="g g-Whitespace">   </span><span class="mi">1298</span> <span class="c1"># setup metadata store</span>
<span class="ne">-&gt; </span><span class="mi">1299</span> <span class="n">meta_store</span> <span class="o">=</span> <span class="n">ConsolidatedStoreClass</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">metadata_key</span><span class="o">=</span><span class="n">metadata_key</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1301</span> <span class="c1"># pass through</span>
<span class="g g-Whitespace">   </span><span class="mi">1302</span> <span class="n">chunk_store</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;chunk_store&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">store</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/zarr/storage.py:2886,</span> in <span class="ni">ConsolidatedMetadataStore.__init__</span><span class="nt">(self, store, metadata_key)</span>
<span class="g g-Whitespace">   </span><span class="mi">2883</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">Store</span><span class="o">.</span><span class="n">_ensure_store</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2885</span> <span class="c1"># retrieve consolidated metadata</span>
<span class="ne">-&gt; </span><span class="mi">2886</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">json_loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">[</span><span class="n">metadata_key</span><span class="p">])</span>
<span class="g g-Whitespace">   </span><span class="mi">2888</span> <span class="c1"># check format of consolidated metadata</span>
<span class="g g-Whitespace">   </span><span class="mi">2889</span> <span class="n">consolidated_format</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;zarr_consolidated_format&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/zarr/storage.py:1393,</span> in <span class="ni">FSStore.__getitem__</span><span class="nt">(self, key)</span>
<span class="g g-Whitespace">   </span><span class="mi">1391</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1392</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1393</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<span class="g g-Whitespace">   </span><span class="mi">1394</span> <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1395</span>     <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/fsspec/mapping.py:143,</span> in <span class="ni">FSMap.__getitem__</span><span class="nt">(self, key, default)</span>
<span class="g g-Whitespace">    </span><span class="mi">141</span> <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_to_str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">142</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">143</span>     <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">144</span> <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing_exceptions</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">145</span>     <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/fsspec/asyn.py:115,</span> in <span class="ni">sync_wrapper.&lt;locals&gt;.wrapper</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">112</span> <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">113</span> <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">114</span>     <span class="bp">self</span> <span class="o">=</span> <span class="n">obj</span> <span class="ow">or</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="ne">--&gt; </span><span class="mi">115</span>     <span class="k">return</span> <span class="n">sync</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/fsspec/asyn.py:100,</span> in <span class="ni">sync</span><span class="nt">(loop, func, timeout, *args, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">98</span>     <span class="k">raise</span> <span class="n">FSTimeoutError</span> <span class="kn">from</span> <span class="nn">return_result</span>
<span class="g g-Whitespace">     </span><span class="mi">99</span> <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">return_result</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">100</span>     <span class="k">raise</span> <span class="n">return_result</span>
<span class="g g-Whitespace">    </span><span class="mi">101</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">102</span>     <span class="k">return</span> <span class="n">return_result</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/fsspec/asyn.py:55,</span> in <span class="ni">_runner</span><span class="nt">(event, coro, result, timeout)</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span>     <span class="n">coro</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">54</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">55</span>     <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">coro</span>
<span class="g g-Whitespace">     </span><span class="mi">56</span> <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">57</span>     <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ex</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/fsspec/asyn.py:414,</span> in <span class="ni">AsyncFileSystem._cat</span><span class="nt">(self, path, recursive, on_error, batch_size, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">412</span>     <span class="n">ex</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">is_exception</span><span class="p">,</span> <span class="n">out</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">413</span>     <span class="k">if</span> <span class="n">ex</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">414</span>         <span class="k">raise</span> <span class="n">ex</span>
<span class="g g-Whitespace">    </span><span class="mi">415</span> <span class="k">if</span> <span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">416</span>     <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
<span class="g g-Whitespace">    </span><span class="mi">417</span>     <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">418</span>     <span class="ow">or</span> <span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strip_protocol</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">419</span> <span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">420</span>     <span class="k">return</span> <span class="p">{</span>
<span class="g g-Whitespace">    </span><span class="mi">421</span>         <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
<span class="nn">    422         for k, v</span> in <span class="ni">zip</span><span class="nt">(paths, out)</span>
<span class="g g-Whitespace">    </span><span class="mi">423</span>         <span class="k">if</span> <span class="n">on_error</span> <span class="o">!=</span> <span class="s2">&quot;omit&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_exception</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">424</span>     <span class="p">}</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/asyncio/tasks.py:408,</span> in <span class="ni">wait_for</span><span class="nt">(fut, timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">405</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">407</span> <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">408</span>     <span class="k">return</span> <span class="k">await</span> <span class="n">fut</span>
<span class="g g-Whitespace">    </span><span class="mi">410</span> <span class="k">if</span> <span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">411</span>     <span class="n">fut</span> <span class="o">=</span> <span class="n">ensure_future</span><span class="p">(</span><span class="n">fut</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/s3fs/core.py:1050,</span> in <span class="ni">S3FileSystem._cat_file</span><span class="nt">(self, path, version_id, start, end)</span>
<span class="g g-Whitespace">   </span><span class="mi">1047</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1048</span>         <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;Body&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="ne">-&gt; </span><span class="mi">1050</span> <span class="k">return</span> <span class="k">await</span> <span class="n">_error_wrapper</span><span class="p">(</span><span class="n">_call_and_read</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">retries</span><span class="p">)</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/s3fs/core.py:139,</span> in <span class="ni">_error_wrapper</span><span class="nt">(func, args, kwargs, retries)</span>
<span class="g g-Whitespace">    </span><span class="mi">137</span>         <span class="n">err</span> <span class="o">=</span> <span class="n">e</span>
<span class="g g-Whitespace">    </span><span class="mi">138</span> <span class="n">err</span> <span class="o">=</span> <span class="n">translate_boto_error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">139</span> <span class="k">raise</span> <span class="n">err</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/s3fs/core.py:112,</span> in <span class="ni">_error_wrapper</span><span class="nt">(func, args, kwargs, retries)</span>
<span class="g g-Whitespace">    </span><span class="mi">110</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">retries</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">111</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">112</span>         <span class="k">return</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">113</span>     <span class="k">except</span> <span class="n">S3_RETRYABLE_ERRORS</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">114</span>         <span class="n">err</span> <span class="o">=</span> <span class="n">e</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/s3fs/core.py:1037,</span> in <span class="ni">S3FileSystem._cat_file.&lt;locals&gt;._call_and_read</span><span class="nt">()</span>
<span class="g g-Whitespace">   </span><span class="mi">1036</span> <span class="k">async</span> <span class="k">def</span> <span class="nf">_call_and_read</span><span class="p">():</span>
<span class="ne">-&gt; </span><span class="mi">1037</span>     <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_s3</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1038</span>         <span class="s2">&quot;get_object&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1039</span>         <span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1040</span>         <span class="n">Key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1041</span>         <span class="o">**</span><span class="n">version_id_kw</span><span class="p">(</span><span class="n">version_id</span> <span class="ow">or</span> <span class="n">vers</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1042</span>         <span class="o">**</span><span class="n">head</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1043</span>         <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">req_kw</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1044</span>     <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1045</span>     <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1046</span>         <span class="k">return</span> <span class="k">await</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;Body&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/s3fs/core.py:340,</span> in <span class="ni">S3FileSystem._call_s3</span><span class="nt">(self, method, *akwarglist, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">339</span> <span class="k">async</span> <span class="k">def</span> <span class="nf">_call_s3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">akwarglist</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">340</span>     <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_session</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">341</span>     <span class="n">s3</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_s3</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Bucket&quot;</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">342</span>     <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">s3</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/s3fs/core.py:526,</span> in <span class="ni">S3FileSystem.set_session</span><span class="nt">(self, refresh, kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">522</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">523</span>     <span class="n">s3creator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">create_client</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">524</span>         <span class="s2">&quot;s3&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">conf</span><span class="p">,</span> <span class="o">**</span><span class="n">init_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">client_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">525</span>     <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">526</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_s3</span> <span class="o">=</span> <span class="k">await</span> <span class="n">s3creator</span><span class="o">.</span><span class="fm">__aenter__</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span> <span class="bp">self</span><span class="o">.</span><span class="n">_s3creator</span> <span class="o">=</span> <span class="n">s3creator</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span> <span class="c1"># the following actually closes the aiohttp connection; use of privates</span>
<span class="g g-Whitespace">    </span><span class="mi">530</span> <span class="c1"># might break in the future, would cause exception at gc time</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/aiobotocore/session.py:26,</span> in <span class="ni">ClientCreatorContext.__aenter__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">     </span><span class="mi">25</span> <span class="k">async</span> <span class="k">def</span> <span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AioBaseClient</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">26</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coro</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span>     <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="fm">__aenter__</span><span class="p">()</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/aiobotocore/session.py:136,</span> in <span class="ni">AioSession._create_client</span><span class="nt">(self, service_name, region_name, api_version, use_ssl, verify, endpoint_url, aws_access_key_id, aws_secret_access_key, aws_session_token, config)</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span> <span class="k">elif</span> <span class="n">default_client_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">134</span>     <span class="n">config</span> <span class="o">=</span> <span class="n">default_client_config</span>
<span class="ne">--&gt; </span><span class="mi">136</span> <span class="n">region_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_region_name</span><span class="p">(</span><span class="n">region_name</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">138</span> <span class="c1"># Figure out the verify value base on the various</span>
<span class="g g-Whitespace">    </span><span class="mi">139</span> <span class="c1"># configuration options.</span>
<span class="g g-Whitespace">    </span><span class="mi">140</span> <span class="k">if</span> <span class="n">verify</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/botocore/session.py:973,</span> in <span class="ni">Session._resolve_region_name</span><span class="nt">(self, region_name, config)</span>
<span class="g g-Whitespace">    </span><span class="mi">971</span>         <span class="n">region_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">region_name</span>
<span class="g g-Whitespace">    </span><span class="mi">972</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">973</span>         <span class="n">region_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config_variable</span><span class="p">(</span><span class="s1">&#39;region&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">975</span> <span class="n">validate_region_name</span><span class="p">(</span><span class="n">region_name</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">976</span> <span class="c1"># For any client that we create in retrieving credentials</span>
<span class="g g-Whitespace">    </span><span class="mi">977</span> <span class="c1"># we want to create it using the same region as specified in</span>
<span class="g g-Whitespace">    </span><span class="mi">978</span> <span class="c1"># creating this client. It is important to note though that the</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">983</span> <span class="c1"># the credentials returned at regional endpoints are valid across</span>
<span class="g g-Whitespace">    </span><span class="mi">984</span> <span class="c1"># all regions in the partition.</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/botocore/session.py:305,</span> in <span class="ni">Session.get_config_variable</span><span class="nt">(self, logical_name, methods)</span>
<span class="g g-Whitespace">    </span><span class="mi">301</span> <span class="k">if</span> <span class="n">methods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">302</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_config_variable_with_custom_methods</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">303</span>         <span class="n">logical_name</span><span class="p">,</span> <span class="n">methods</span>
<span class="g g-Whitespace">    </span><span class="mi">304</span>     <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">305</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_component</span><span class="p">(</span><span class="s1">&#39;config_store&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_config_variable</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">306</span>     <span class="n">logical_name</span>
<span class="g g-Whitespace">    </span><span class="mi">307</span> <span class="p">)</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/botocore/configprovider.py:426,</span> in <span class="ni">ConfigValueStore.get_config_variable</span><span class="nt">(self, logical_name)</span>
<span class="g g-Whitespace">    </span><span class="mi">424</span>     <span class="k">return</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">425</span> <span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span><span class="p">[</span><span class="n">logical_name</span><span class="p">]</span>
<span class="ne">--&gt; </span><span class="mi">426</span> <span class="k">return</span> <span class="n">provider</span><span class="o">.</span><span class="n">provide</span><span class="p">()</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/botocore/configprovider.py:628,</span> in <span class="ni">ChainProvider.provide</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">621</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;Provide the value from the first provider to return non-None.</span>
<span class="g g-Whitespace">    </span><span class="mi">622</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">623</span><span class="sd"> Each provider in the chain has its provide method called. The first</span>
<span class="g g-Whitespace">    </span><span class="mi">624</span><span class="sd"> one in the chain to return a non-None value is the returned from the</span>
<span class="g g-Whitespace">    </span><span class="mi">625</span><span class="sd"> ChainProvider. When no non-None value is found, None is returned.</span>
<span class="g g-Whitespace">    </span><span class="mi">626</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">627</span> <span class="k">for</span> <span class="n">provider</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_providers</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">628</span>     <span class="n">value</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">provide</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">629</span>     <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">630</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/botocore/configprovider.py:718,</span> in <span class="ni">ScopedConfigProvider.provide</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">716</span> <span class="k">def</span> <span class="nf">provide</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">717</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Provide a value from a config file property.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">718</span>     <span class="n">scoped_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">get_scoped_config</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">719</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_var_name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">720</span>         <span class="n">section_config</span> <span class="o">=</span> <span class="n">scoped_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config_var_name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nn">File /home/conda/users/ef214d1986de9477d5223419ba4838d76e9839b19e4fb02c9e208c97cab5a61b-20230329-131713-443303-165-pangeofu/lib/python3.10/site-packages/botocore/session.py:404,</span> in <span class="ni">Session.get_scoped_config</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">399</span>     <span class="k">return</span> <span class="n">profile_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="g g-Whitespace">    </span><span class="mi">400</span> <span class="k">elif</span> <span class="n">profile_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">profile_map</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">401</span>     <span class="c1"># Otherwise if they specified a profile, it has to</span>
<span class="g g-Whitespace">    </span><span class="mi">402</span>     <span class="c1"># exist (even if it&#39;s the default profile) otherwise</span>
<span class="g g-Whitespace">    </span><span class="mi">403</span>     <span class="c1"># we complain.</span>
<span class="ne">--&gt; </span><span class="mi">404</span>     <span class="k">raise</span> <span class="n">ProfileNotFound</span><span class="p">(</span><span class="n">profile</span><span class="o">=</span><span class="n">profile_name</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">405</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">406</span>     <span class="k">return</span> <span class="n">profile_map</span><span class="p">[</span><span class="n">profile_name</span><span class="p">]</span>

<span class="ne">ProfileNotFound</span>: The config profile (osn-renci) could not be found
</pre></div>
</div>
</div>
</div>
</section>
<section id="restrict-for-tutorial">
<h2>Restrict for Tutorial<a class="headerlink" href="#restrict-for-tutorial" title="Permalink to this headline">#</a></h2>
<p>This is a demonstration workflow, which means we don’t really need to work on the entire
dataset – which is very large. We are going to cut this input dataset down to be just the
first 100 <code class="docutils literal notranslate"><span class="pre">feature_id</span></code> values, so that this tutorial will run in reasonable time.</p>
<p>For processing a full-sized dataset, you’d just skip this step where we slice off a representative
example of the data. Expect run time to increase in proportion to the size of the data being
processed. |</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smplData</span> <span class="o">=</span> <span class="n">smplData</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">feature_id</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
<span class="n">smplData</span>
</pre></div>
</div>
</div>
</div>
<p>Note that this data has the full range of time values (367439 time steps) and all of the
variables (<code class="docutils literal notranslate"><span class="pre">streamflow</span></code>, <code class="docutils literal notranslate"><span class="pre">velocity</span></code>, …). We just selected 100 feature_ids to work with so
that the example data will execute more quickly.</p>
</section>
<section id="spin-up-dask-cluster">
<h2>Spin up Dask Cluster<a class="headerlink" href="#spin-up-dask-cluster" title="Permalink to this headline">#</a></h2>
<p>Our rechunking operation will be able to work in parallel. To do that, we will
spin up a <code class="docutils literal notranslate"><span class="pre">dask</span></code> cluster on the cloud hardware to schedule the various workers.
Note that this cluster must be configured with a specific user <strong>profile</strong> with
permissions to write to our eventual output location.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">run</span> ../../../environment_set_up/Start_Dask_Cluster_Nebari.ipynb
</pre></div>
</div>
</div>
</div>
</section>
<section id="re-chunk-plan">
<h2>Re-Chunk Plan<a class="headerlink" href="#re-chunk-plan" title="Permalink to this headline">#</a></h2>
<p>We will configure a new chunking plan which will favor time-series analysis.
Using the dimensions of the data:</p>
<ul class="simple">
<li><p>367439 time steps</p></li>
<li><p>100 feature IDs</p></li>
</ul>
<p>We can write the new plan as:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The new chunking plan:</span>
<span class="n">chunk_plan</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;streamflow&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="mi">367439</span><span class="p">,</span> <span class="s1">&#39;feature_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># all time records in one chunk for each feature_id</span>
    <span class="s1">&#39;velocity&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="mi">367439</span><span class="p">,</span> <span class="s1">&#39;feature_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="s1">&#39;elevation&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">100</span><span class="p">,),</span>
    <span class="s1">&#39;gage_id&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">100</span><span class="p">,),</span>
    <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">100</span><span class="p">,),</span>
    <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">100</span><span class="p">,),</span>    
    <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">100</span><span class="p">,),</span>    
    <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">367439</span><span class="p">,),</span> <span class="c1"># all time coordinates in one chunk</span>
    <span class="s1">&#39;feature_id&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">100</span><span class="p">,)</span> <span class="c1"># all feature_id coordinates in one chunk</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>This will generate chunks which are 1(feature_id) x 367439(time) arrays of <code class="docutils literal notranslate"><span class="pre">float64</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#       time  * id * float64</span>
<span class="nb">bytes</span> <span class="o">=</span> <span class="mi">367439</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">8</span>
<span class="n">kbytes</span> <span class="o">=</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">10</span><span class="p">)</span>
<span class="n">mbytes</span> <span class="o">=</span> <span class="n">kbytes</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;chunk size: </span><span class="si">{</span><span class="nb">bytes</span><span class="si">=}</span><span class="s2"> (</span><span class="si">{</span><span class="n">kbytes</span><span class="si">=:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)(</span><span class="si">{</span><span class="n">mbytes</span><span class="si">=:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Manually reset the chunking metadata in prep for re-chunking</span>
<span class="n">smplData</span> <span class="o">=</span> <span class="n">smplData</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">chunks</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;feature_id&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="mi">367439</span><span class="p">})</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">smplData</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
    <span class="n">smplData</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">encoding</span><span class="p">[</span><span class="s1">&#39;chunks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="set-up-output-location">
<h2>Set up output location<a class="headerlink" href="#set-up-output-location" title="Permalink to this headline">#</a></h2>
<p>With this plan, we can ask <code class="docutils literal notranslate"><span class="pre">rechunker</span></code> to re-write the data using the prescribed chunking pattern.</p>
<p>Unlike with the smaller dataset, we need to write this very large dataset to an object store in the datacenter: an S3 ‘bucket’.  So we need to set that up so that <code class="docutils literal notranslate"><span class="pre">rechunker</span></code> will have a suitable place to write data. This new data will be a complete copy of the original, just re-organized a bit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">getpass</span> <span class="kn">import</span> <span class="n">getuser</span>
<span class="kn">import</span> <span class="nn">fsspec</span>
<span class="n">uname</span><span class="o">=</span><span class="n">getuser</span><span class="p">()</span>

<span class="n">fsw</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">filesystem</span><span class="p">(</span>
    <span class="s1">&#39;s3&#39;</span><span class="p">,</span> 
    <span class="n">anon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
    <span class="n">default_fill_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
    <span class="n">skip_instance_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
    <span class="n">client_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;endpoint_url&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AWS_S3_ENDPOINT&#39;</span><span class="p">],</span> <span class="p">}</span>
<span class="p">)</span>

<span class="n">workspace</span> <span class="o">=</span> <span class="s1">&#39;s3://rsignellbucket2/&#39;</span>
<span class="n">testDir</span> <span class="o">=</span> <span class="n">workspace</span> <span class="o">+</span> <span class="s2">&quot;testing/&quot;</span>
<span class="n">myDir</span> <span class="o">=</span> <span class="n">testDir</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">uname</span><span class="si">}</span><span class="s1">/&#39;</span>
<span class="n">fsw</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">testDir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">staging</span> <span class="o">=</span> <span class="n">fsw</span><span class="o">.</span><span class="n">get_mapper</span><span class="p">(</span><span class="n">myDir</span> <span class="o">+</span> <span class="s1">&#39;tutorial_staging.zarr&#39;</span><span class="p">)</span>
<span class="n">outfile</span> <span class="o">=</span> <span class="n">fsw</span><span class="o">.</span><span class="n">get_mapper</span><span class="p">(</span><span class="n">myDir</span> <span class="o">+</span> <span class="s1">&#39;tutorial_rechunked.zarr&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="ready-to-rechunk">
<h2>Ready to rechunk<a class="headerlink" href="#ready-to-rechunk" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">rechunker</span>
<span class="c1">## Recall that merely invoking rechunker does not do any work... just sorts out </span>
<span class="c1">## the rechunking plan and writes metadata.</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">rechunker</span><span class="o">.</span><span class="n">rechunk</span><span class="p">(</span>
    <span class="n">smplData</span><span class="p">,</span>
    <span class="n">chunk_plan</span><span class="p">,</span>
    <span class="s2">&quot;16GB&quot;</span><span class="p">,</span>
    <span class="n">outfile</span><span class="p">,</span> 
    <span class="n">temp_store</span><span class="o">=</span><span class="n">staging</span><span class="p">,</span> 
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">progress</span><span class="p">,</span> <span class="n">performance_report</span>

<span class="k">with</span> <span class="n">performance_report</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;dask-report.html&quot;</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">zarr</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">consolidate_metadata</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="results">
<h2>Results<a class="headerlink" href="#results" title="Permalink to this headline">#</a></h2>
<p>Let’s read in the resulting re-chunked dataset to see how it looks:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reChunkedData</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
<span class="n">reChunkedData</span>
</pre></div>
</div>
</div>
</div>
<section id="comparison">
<h3>Comparison<a class="headerlink" href="#comparison" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Before:</span>
<span class="n">smplData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">indexer</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># subset to only those features with a valid gage_id</span>
<span class="n">smplData</span><span class="p">[</span><span class="s1">&#39;streamflow&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">feature_id</span><span class="o">=</span><span class="mi">417955</span><span class="p">)</span>
<span class="c1"># Note: many chunks needed to service a single feature_id</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## After:</span>
<span class="n">reChunkedData</span><span class="p">[</span><span class="s1">&#39;streamflow&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">feature_id</span><span class="o">=</span><span class="mi">417955</span><span class="p">)</span> 
<span class="c1"># All data for the specified feature_id is in a single chunk</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">cluster</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./dataset_preprocessing/tutorials/rechunking"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="ReChunkingData.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Re-Chunking Data</p>
      </div>
    </a>
    <a class="right-next"
       href="../../../evaluation/metrics.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Evaluation Metrics</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#system-setup">System Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plumb-data-source">Plumb Data Source</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-zarr-data">Load the zarr data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#restrict-for-tutorial">Restrict for Tutorial</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#spin-up-dask-cluster">Spin up Dask Cluster</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#re-chunk-plan">Re-Chunk Plan</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-output-location">Set up output location</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ready-to-rechunk">Ready to rechunk</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison">Comparison</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            <div class="bd-footer-content__inner">
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book community
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div></div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>